environment:
  name: content-generation
  location: eastus

name: content-generation
metadata:
  template: content-generation@1.22

requiredVersions:
  azd: '>= 1.18.0'

parameters:
  solutionPrefix:
    type: string
    default: contentgen
    displayName: Solution Prefix
    description: A unique prefix for all resources (3-15 chars)
  azureAiServiceLocation:
    type: string
    default: eastus
    displayName: AI Services Location
    description: Location for Azure AI Services deployments
  enableMonitoring:
    type: boolean
    default: false
    displayName: Enable Monitoring (WAF)
    description: Enable Log Analytics and Application Insights
  enableScalability:
    type: boolean
    default: false
    displayName: Enable Scalability (WAF)
    description: Enable auto-scaling and higher SKUs
  enableRedundancy:
    type: boolean
    default: false
    displayName: Enable Redundancy (WAF)
    description: Enable zone redundancy and geo-replication
  enablePrivateNetworking:
    type: boolean
    default: false
    displayName: Enable Private Networking (WAF)
    description: Enable VNet integration and private endpoints

infra:
  provider: bicep
  path: ./infra
  module: main

# Custom workflow: 
# 1. First provision creates infrastructure (skips ACI for private networking)
# 2. Build container image to ACR
# 3. Second provision creates ACI with the now-available image
workflows:
  up:
    steps:
      - azd: provision

hooks:
  preprovision:
    windows:
      run: |
        Write-Host "Preparing Content Generation Solution Accelerator deployment..." -ForegroundColor Cyan
        Write-Host "Checking Azure CLI authentication..."
        az account show --query "{name:name, id:id}" -o table
        
        # For private networking on first run, skip ACI (image not yet in ACR)
        $currentSkip = azd env get-value skipContainerDeployment 2>$null
        if ($env:enablePrivateNetworking -eq 'true' -and -not $env:ACR_NAME -and $currentSkip -ne 'false') {
          Write-Host "Private networking enabled - skipping container deployment until image is built" -ForegroundColor Yellow
          azd env set skipContainerDeployment true
        }
      shell: pwsh
      continueOnError: false
    posix:
      run: |
        echo "Preparing Content Generation Solution Accelerator deployment..."
        echo "Checking Azure CLI authentication..."
        az account show --query "{name:name, id:id}" -o table
        
        # For private networking on first run, skip ACI (image not yet in ACR)
        current_skip=$(azd env get-value skipContainerDeployment 2>/dev/null || echo "")
        if [ "$enablePrivateNetworking" = "true" ] && [ -z "$ACR_NAME" ] && [ "$current_skip" != "false" ]; then
          echo "Private networking enabled - skipping container deployment until image is built"
          azd env set skipContainerDeployment true
        fi
      shell: sh
      continueOnError: false

  postprovision:
    windows:
      run: |
        Write-Host "===== Provision Complete =====" -ForegroundColor Green
        Write-Host ""
        Write-Host "Web App URL: " -NoNewline
        Write-Host "$env:WEB_APP_URL" -ForegroundColor Cyan
        Write-Host "Storage Account: " -NoNewline
        Write-Host "$env:STORAGE_ACCOUNT_NAME" -ForegroundColor Cyan
        Write-Host "AI Search Service: " -NoNewline
        Write-Host "$env:AI_SEARCH_SERVICE_NAME" -ForegroundColor Cyan
        Write-Host "AI Search Index: " -NoNewline
        Write-Host "$env:AI_SEARCH_INDEX" -ForegroundColor Cyan
        Write-Host "AI Service Location: " -NoNewline
        Write-Host "$env:AI_SERVICE_LOCATION" -ForegroundColor Cyan
        
        # Run post-deployment role assignments
        Write-Host ""
        Write-Host "===== Running Post-Deployment Configuration =====" -ForegroundColor Yellow
        
        # Assign Cosmos DB role to current user
        Write-Host "Assigning Cosmos DB Data Contributor role..."
        $signedUserId = az ad signed-in-user show --query id -o tsv
        az cosmosdb sql role assignment create --resource-group $env:RESOURCE_GROUP_NAME --account-name $env:COSMOSDB_ACCOUNT_NAME --role-definition-id "00000000-0000-0000-0000-000000000002" --principal-id $signedUserId --scope "/" 2>$null
        if ($LASTEXITCODE -eq 0) {
          Write-Host "  Cosmos DB role assigned successfully" -ForegroundColor Green
        } else {
          Write-Host "  Cosmos DB role may already be assigned" -ForegroundColor Yellow
        }
        
        # Build container image and deploy ACI if ACR exists and ACI was skipped
        $skipContainer = azd env get-value skipContainerDeployment 2>$null
        if ($env:ACR_NAME -and $skipContainer -eq 'true') {
          Write-Host ""
          Write-Host "===== Building Container Image =====" -ForegroundColor Yellow
          Write-Host "Building and pushing image to ACR: $env:ACR_NAME" -ForegroundColor Cyan
          
          az acr build --registry $env:ACR_NAME --image content-gen-app:latest --file ./src/WebApp.Dockerfile ./src
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Container image built and pushed successfully!" -ForegroundColor Green
            
            # Enable container deployment and re-provision
            Write-Host ""
            Write-Host "===== Deploying Container Instance =====" -ForegroundColor Yellow
            azd env set skipContainerDeployment false
            
            Write-Host "Re-running provision to deploy ACI..." -ForegroundColor Cyan
            azd provision --no-prompt
            
            if ($LASTEXITCODE -eq 0) {
              Write-Host "Container Instance deployed successfully!" -ForegroundColor Green
            } else {
              Write-Host "Container Instance deployment failed" -ForegroundColor Red
            }
          } else {
            Write-Host "Failed to build container image" -ForegroundColor Red
          }
        } elseif ($env:CONTAINER_INSTANCE_NAME) {
          Write-Host ""
          Write-Host "Container Instance: " -NoNewline
          Write-Host "$env:CONTAINER_INSTANCE_NAME" -ForegroundColor Cyan
          Write-Host "Container Private IP: " -NoNewline
          Write-Host "$env:CONTAINER_INSTANCE_PRIVATE_IP" -ForegroundColor Cyan
        } elseif ($env:ACR_NAME) {
          Write-Host ""
          Write-Host "Container Registry: " -NoNewline
          Write-Host "$env:ACR_NAME" -ForegroundColor Cyan
        }
        
        # Build and deploy frontend to App Service
        Write-Host ""
        Write-Host "===== Building Frontend =====" -ForegroundColor Yellow
        Push-Location ./src/frontend
        npm install
        npm run build
        
        if ($LASTEXITCODE -eq 0) {
          Write-Host "Frontend build completed!" -ForegroundColor Green
          
          # Copy build to frontend-server
          Copy-Item -Path ../static/* -Destination ../frontend-server/static/ -Recurse -Force -ErrorAction SilentlyContinue
          
          Push-Location ../frontend-server
          
          # Create deployment package
          Write-Host "Creating deployment package..."
          Remove-Item -Path frontend-deploy.zip -Force -ErrorAction SilentlyContinue
          Compress-Archive -Path static, server.js, package.json, package-lock.json -DestinationPath frontend-deploy.zip -Force
          
          Write-Host ""
          Write-Host "===== Deploying Frontend to App Service =====" -ForegroundColor Yellow
          az webapp deploy --resource-group $env:RESOURCE_GROUP_NAME --name $env:APP_SERVICE_NAME --src-path frontend-deploy.zip --type zip
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Frontend deployed successfully!" -ForegroundColor Green
          } else {
            Write-Host "Frontend deployment failed" -ForegroundColor Red
          }
          
          Pop-Location
        } else {
          Write-Host "Frontend build failed" -ForegroundColor Red
        }
        Pop-Location
        
        # Run post-deploy script to upload sample data and create search index
        Write-Host ""
        Write-Host "===== Running Post-Deploy Script =====" -ForegroundColor Yellow
        Write-Host "This will upload sample data and create the search index..."

        # Ensure post-deploy Python dependencies are installed
        $python = "python"
        if (Test-Path "./.venv/Scripts/python.exe") { $python = "./.venv/Scripts/python.exe" }
        elseif (Test-Path "../.venv/Scripts/python.exe") { $python = "../.venv/Scripts/python.exe" }
        elseif (Test-Path "./.venv/bin/python") { $python = "./.venv/bin/python" }
        elseif (Test-Path "../.venv/bin/python") { $python = "../.venv/bin/python" }
        & $python -m pip install -r ./scripts/requirements-post-deploy.txt
        
        if (Test-Path "./scripts/post_deploy.py") {
          & $python ./scripts/post_deploy.py `
            --resource-group $env:RESOURCE_GROUP_NAME `
            --app-name $env:APP_SERVICE_NAME `
            --skip-tests
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Post-deploy script completed successfully!" -ForegroundColor Green
          } else {
            Write-Host "Post-deploy script completed with warnings (some steps may have failed)" -ForegroundColor Yellow
          }
        } else {
          Write-Host "Warning: post_deploy.py not found, skipping sample data upload" -ForegroundColor Yellow
        }
        
        Write-Host ""
        Write-Host "===== Deployment Complete =====" -ForegroundColor Green
        Write-Host ""
        Write-Host "Access the web application:"
        Write-Host "   $env:WEB_APP_URL" -ForegroundColor Cyan
      shell: pwsh
      continueOnError: false
      interactive: true
    posix:
      run: |
        echo "===== Provision Complete ====="
        echo ""
        echo "Web App URL: $WEB_APP_URL"
        echo "Storage Account: $STORAGE_ACCOUNT_NAME"
        echo "AI Search Service: $AI_SEARCH_SERVICE_NAME"
        echo "AI Search Index: $AI_SEARCH_INDEX"
        echo "AI Service Location: $AI_SERVICE_LOCATION"
        
        # Run post-deployment role assignments
        echo ""
        echo "===== Running Post-Deployment Configuration ====="
        
        # Assign Cosmos DB role to current user
        echo "Assigning Cosmos DB Data Contributor role..."
        signed_user_id=$(az ad signed-in-user show --query id -o tsv)
        az cosmosdb sql role assignment create \
          --resource-group "$RESOURCE_GROUP_NAME" \
          --account-name "$COSMOSDB_ACCOUNT_NAME" \
          --role-definition-id "00000000-0000-0000-0000-000000000002" \
          --principal-id "$signed_user_id" \
          --scope "/" 2>/dev/null && echo "  Cosmos DB role assigned successfully" || echo "  Cosmos DB role may already be assigned"
        
        # Build container image and deploy ACI if ACR exists and ACI was skipped
        skip_container=$(azd env get-value skipContainerDeployment 2>/dev/null || echo "")
        if [ -n "$ACR_NAME" ] && [ "$skip_container" = "true" ]; then
          echo ""
          echo "===== Building Container Image ====="
          echo "Building and pushing image to ACR: $ACR_NAME"
          
          if az acr build --registry "$ACR_NAME" --image content-gen-app:latest --file ./src/WebApp.Dockerfile ./src; then
            echo "Container image built and pushed successfully!"
            
            # Enable container deployment and re-provision
            echo ""
            echo "===== Deploying Container Instance ====="
            azd env set skipContainerDeployment false
            
            echo "Re-running provision to deploy ACI..."
            if azd provision --no-prompt; then
              echo "Container Instance deployed successfully!"
            else
              echo "Container Instance deployment failed"
            fi
          else
            echo "Failed to build container image"
          fi
        elif [ -n "$CONTAINER_INSTANCE_NAME" ]; then
          echo ""
          echo "Container Instance: $CONTAINER_INSTANCE_NAME"
          echo "Container Private IP: $CONTAINER_INSTANCE_PRIVATE_IP"
        elif [ -n "$ACR_NAME" ]; then
          echo ""
          echo "Container Registry: $ACR_NAME"
        fi
        
        # Build and deploy frontend to App Service
        echo ""
        echo "===== Building Frontend ====="
        cd ./src/frontend
        if npm install && npm run build; then
          echo "Frontend build completed!"
          
          # Copy build to frontend-server
          cp -r ../static/* ../frontend-server/static/ 2>/dev/null || true
          
          cd ../frontend-server
          
          # Create deployment package
          echo "Creating deployment package..."
          rm -f frontend-deploy.zip
          zip -r frontend-deploy.zip static/ server.js package.json package-lock.json
          
          echo ""
          echo "===== Deploying Frontend to App Service ====="
          if az webapp deploy \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --name "$APP_SERVICE_NAME" \
            --src-path frontend-deploy.zip \
            --type zip; then
            echo "Frontend deployed successfully!"
          else
            echo "Frontend deployment failed"
          fi
          
          cd ../..
        else
          echo "Frontend build failed"
          cd ../..
        fi
        
        # Run post-deploy script to upload sample data and create search index
        echo ""
        echo "===== Running Post-Deploy Script ====="
        echo "This will upload sample data and create the search index..."
        
        if [ -f "./scripts/post_deploy.py" ]; then
          # Prefer local venv if present (repo root or content-gen)
          if [ -x "./.venv/bin/python" ]; then
            PYTHON_BIN="./.venv/bin/python"
          elif [ -x "../.venv/bin/python" ]; then
            PYTHON_BIN="../.venv/bin/python"
          else
            PYTHON_BIN="python3"
          fi

          "$PYTHON_BIN" -m pip install -r ./scripts/requirements-post-deploy.txt \
            && "$PYTHON_BIN" ./scripts/post_deploy.py \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --app-name "$APP_SERVICE_NAME" \
            --skip-tests \
            && echo "Post-deploy script completed successfully!" \
            || echo "Post-deploy script completed with warnings (some steps may have failed)"
        else
          echo "Warning: post_deploy.py not found, skipping sample data upload"
        fi
        
        echo ""
        echo "===== Deployment Complete ====="
        echo ""
        echo "Access the web application:"
        echo "   $WEB_APP_URL"
      shell: sh
      continueOnError: false
      interactive: true
