environment:
  name: content-generation
  location: eastus

name: content-generation
metadata:
  template: content-generation@1.22

requiredVersions:
  azd: '>= 1.18.0'

parameters:
  solutionPrefix:
    type: string
    default: contentgen
    displayName: Solution Prefix
    description: A unique prefix for all resources (3-15 chars)
  azureAiServiceLocation:
    type: string
    default: eastus
    displayName: AI Services Location
    description: Location for Azure AI Services deployments
  enableMonitoring:
    type: boolean
    default: false
    displayName: Enable Monitoring (WAF)
    description: Enable Log Analytics and Application Insights
  enableScalability:
    type: boolean
    default: false
    displayName: Enable Scalability (WAF)
    description: Enable auto-scaling and higher SKUs
  enableRedundancy:
    type: boolean
    default: false
    displayName: Enable Redundancy (WAF)
    description: Enable zone redundancy and geo-replication
  enablePrivateNetworking:
    type: boolean
    default: false
    displayName: Enable Private Networking (WAF)
    description: Enable VNet integration and private endpoints

infra:
  provider: bicep
  path: ./infra
  module: main

workflows:
  up:
    steps:
      - azd: provision

hooks:
  preprovision:
    windows:
      run: |
        Write-Host "Preparing Content Generation Solution Accelerator deployment..." -ForegroundColor Cyan
        Write-Host "Checking Azure CLI authentication..."
        az account show --query "{name:name, id:id}" -o table
        
        # For private networking on first run, skip ACI (image not yet in ACR)
        $currentSkip = azd env get-value skipContainerDeployment 2>$null
        if (-not $?) {
          $currentSkip = ""
          $global:LASTEXITCODE = 0
        }
        if ($env:enablePrivateNetworking -eq 'true' -and -not $env:ACR_NAME -and $currentSkip -ne 'false') {
          Write-Host "Private networking enabled - skipping container deployment until image is built" -ForegroundColor Yellow
          azd env set skipContainerDeployment true
        }
      shell: pwsh
      continueOnError: false
    posix:
      run: |
        echo "Preparing Content Generation Solution Accelerator deployment..."
        echo "Checking Azure CLI authentication..."
        az account show --query "{name:name, id:id}" -o table
        
        # For private networking on first run, skip ACI (image not yet in ACR)
        current_skip=$(azd env get-value skipContainerDeployment 2>/dev/null || echo "")
        if [ "$enablePrivateNetworking" = "true" ] && [ -z "$ACR_NAME" ] && [ "$current_skip" != "false" ]; then
          echo "Private networking enabled - skipping container deployment until image is built"
          azd env set skipContainerDeployment true
        fi
      shell: sh
      continueOnError: false

  postprovision:
    windows:
      run: |
        Write-Host "===== Provision Complete =====" -ForegroundColor Green
        Write-Host ""
        Write-Host "Web App URL: " -NoNewline
        Write-Host "$env:WEB_APP_URL" -ForegroundColor Cyan
        Write-Host "Storage Account: " -NoNewline
        Write-Host "$env:STORAGE_ACCOUNT_NAME" -ForegroundColor Cyan
        Write-Host "AI Search Service: " -NoNewline
        Write-Host "$env:AI_SEARCH_SERVICE_NAME" -ForegroundColor Cyan
        Write-Host "AI Search Index: " -NoNewline
        Write-Host "$env:AI_SEARCH_INDEX" -ForegroundColor Cyan
        Write-Host "AI Service Location: " -NoNewline
        Write-Host "$env:AI_SERVICE_LOCATION" -ForegroundColor Cyan
        
        # Run post-deployment role assignments
        Write-Host ""
        Write-Host "===== Running Post-Deployment Configuration =====" -ForegroundColor Yellow
        
        # Assign Cosmos DB role to current user
        Write-Host "Assigning Cosmos DB Data Contributor role..."
        $signedUserId = az ad signed-in-user show --query id -o tsv
        az cosmosdb sql role assignment create --resource-group $env:RESOURCE_GROUP_NAME --account-name $env:COSMOSDB_ACCOUNT_NAME --role-definition-id "00000000-0000-0000-0000-000000000002" --principal-id $signedUserId --scope "/" 2>$null
        if ($LASTEXITCODE -eq 0) {
          Write-Host "  Cosmos DB role assigned successfully" -ForegroundColor Green
        } else {
          Write-Host "  Cosmos DB role may already be assigned" -ForegroundColor Yellow
        }
        
        if ($env:CONTAINER_INSTANCE_NAME) {
          Write-Host ""
          Write-Host "Container Instance: " -NoNewline
          Write-Host "$env:CONTAINER_INSTANCE_NAME" -ForegroundColor Cyan
          Write-Host "Container Private IP: " -NoNewline
          Write-Host "$env:CONTAINER_INSTANCE_PRIVATE_IP" -ForegroundColor Cyan
        }
        
        
        # Run post-deploy script to upload sample data and create search index
        Write-Host ""
        Write-Host "===== Running Post-Deploy Script =====" -ForegroundColor Yellow
        Write-Host "This will upload sample data and create the search index..."

        # Ensure post-deploy Python dependencies are installed
        $python = "python"
        if (Test-Path "./.venv/Scripts/python.exe") { $python = "./.venv/Scripts/python.exe" }
        elseif (Test-Path "../.venv/Scripts/python.exe") { $python = "../.venv/Scripts/python.exe" }
        elseif (Test-Path "./.venv/bin/python") { $python = "./.venv/bin/python" }
        elseif (Test-Path "../.venv/bin/python") { $python = "../.venv/bin/python" }
        & $python -m pip install -r ./scripts/requirements-post-deploy.txt
        
        if (Test-Path "./scripts/post_deploy.py") {
          & $python ./scripts/post_deploy.py `
            --resource-group $env:RESOURCE_GROUP_NAME `
            --app-name $env:APP_SERVICE_NAME `
            --skip-tests
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Post-deploy script completed successfully!" -ForegroundColor Green
          } else {
            Write-Host "Post-deploy script completed with warnings (some steps may have failed)" -ForegroundColor Yellow
          }
        } else {
          Write-Host "Warning: post_deploy.py not found, skipping sample data upload" -ForegroundColor Yellow
        }
        
        Write-Host ""
        Write-Host "===== Deployment Complete =====" -ForegroundColor Green
        Write-Host ""
        Write-Host "Access the web application:"
        Write-Host "   $env:WEB_APP_URL" -ForegroundColor Cyan
      shell: pwsh
      continueOnError: false
      interactive: true
    posix:
      run: |
        echo "===== Provision Complete ====="
        echo ""
        echo "Web App URL: $WEB_APP_URL"
        echo "Storage Account: $STORAGE_ACCOUNT_NAME"
        echo "AI Search Service: $AI_SEARCH_SERVICE_NAME"
        echo "AI Search Index: $AI_SEARCH_INDEX"
        echo "AI Service Location: $AI_SERVICE_LOCATION"
        
        # Run post-deployment role assignments
        echo ""
        echo "===== Running Post-Deployment Configuration ====="
        
        # Assign Cosmos DB role to current user
        echo "Assigning Cosmos DB Data Contributor role..."
        signed_user_id=$(az ad signed-in-user show --query id -o tsv)
        az cosmosdb sql role assignment create \
          --resource-group "$RESOURCE_GROUP_NAME" \
          --account-name "$COSMOSDB_ACCOUNT_NAME" \
          --role-definition-id "00000000-0000-0000-0000-000000000002" \
          --principal-id "$signed_user_id" \
          --scope "/" 2>/dev/null && echo "  Cosmos DB role assigned successfully" || echo "  Cosmos DB role may already be assigned"
        
        if [ -n "$CONTAINER_INSTANCE_NAME" ]; then
          echo ""
          echo "Container Instance: $CONTAINER_INSTANCE_NAME"
          echo "Container Private IP: $CONTAINER_INSTANCE_PRIVATE_IP"
        fi
        
        echo ""
        echo "Container Registry: $ACR_NAME"
        
        # Run post-deploy script to upload sample data and create search index
        echo ""
        echo "===== Running Post-Deploy Script ====="
        echo "This will upload sample data and create the search index..."
        
        if [ -f "./scripts/post_deploy.py" ]; then
          # Prefer local venv if present (repo root or content-gen)
          if [ -x "./.venv/bin/python" ]; then
            PYTHON_BIN="./.venv/bin/python"
          elif [ -x "../.venv/bin/python" ]; then
            PYTHON_BIN="../.venv/bin/python"
          else
            PYTHON_BIN="python3"
          fi

          "$PYTHON_BIN" -m pip install -r ./scripts/requirements-post-deploy.txt \
            && "$PYTHON_BIN" ./scripts/post_deploy.py \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --app-name "$APP_SERVICE_NAME" \
            --skip-tests \
            && echo "Post-deploy script completed successfully!" \
            || echo "Post-deploy script completed with warnings (some steps may have failed)"
        else
          echo "Warning: post_deploy.py not found, skipping sample data upload"
        fi
        
        echo ""
        echo "===== Deployment Complete ====="
        echo ""
        echo "Access the web application:"
        echo "   $WEB_APP_URL"
      shell: sh
      continueOnError: false
      interactive: true
